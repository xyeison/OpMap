-- Buscar rutas faltantes en travel_time_cache
-- Generado: 2025-08-06T12:15:50.007815

-- Total rutas necesarias: 2608

-- Crear tabla temporal con las rutas necesarias
CREATE TEMP TABLE IF NOT EXISTS routes_needed (
    hospital_id UUID,
    hospital_lat NUMERIC,
    hospital_lng NUMERIC,
    kam_id UUID,
    kam_lat NUMERIC,
    kam_lng NUMERIC
);

-- Insertar rutas necesarias (primeras 100 como ejemplo)
INSERT INTO routes_needed VALUES

('ea797875-97c2-413e-ad9b-a3477ce194aa', 4.43606318, -75.20467167, '0422850d-2cb9-4099-b8e0-010d5dfb15ee', 3.45242438, -76.49312468'), 
('ea797875-97c2-413e-ad9b-a3477ce194aa', 4.43606318, -75.20467167, '75196896-46f6-49c4-85fd-731cd50daf83', 6.2624319, -75.56404755'), 
('ea797875-97c2-413e-ad9b-a3477ce194aa', 4.43606318, -75.20467167, '97d0fec5-fc75-40d5-973d-18a21f9f5e80', 2.93248615, -75.28494502'), 
('ea797875-97c2-413e-ad9b-a3477ce194aa', 4.43606318, -75.20467167, '1b2f89c9-4709-4764-afc2-36a7faafe609', 4.81788814, -75.69976105'), 
('ea797875-97c2-413e-ad9b-a3477ce194aa', 4.43606318, -75.20467167, 'ef69d4fa-63cb-474c-964f-33aa323dc5c9', 4.6337949, -74.06733996'), 
('ea797875-97c2-413e-ad9b-a3477ce194aa', 4.43606318, -75.20467167, '519a4246-fcd8-4ea9-a504-0cc90a98ee48', 4.70709922, -74.10950061'), 
('ea797875-97c2-413e-ad9b-a3477ce194aa', 4.43606318, -75.20467167, '9e9a1f45-e757-4fed-bd53-02bfd1e460da', 4.5703607, -74.08840265'), 
('ea797875-97c2-413e-ad9b-a3477ce194aa', 4.43606318, -75.20467167, '3ce353cc-64d0-454e-9017-e78e20a1ea59', 4.61640679, -74.15623609'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '73875b86-2838-4add-867c-605ae1492d7a', 7.12671431, -73.11446761'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '0422850d-2cb9-4099-b8e0-010d5dfb15ee', 3.45242438, -76.49312468'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '34a97b79-6c6c-44a8-9925-2dc41ffdae8d', 7.89752044, -72.50620117'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '75196896-46f6-49c4-85fd-731cd50daf83', 6.2624319, -75.56404755'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, 'f44b0557-1c17-41b9-ac66-f1ef5d23d75c', 8.75154953, -75.88373388'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '97d0fec5-fc75-40d5-973d-18a21f9f5e80', 2.93248615, -75.28494502'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '1b2f89c9-4709-4764-afc2-36a7faafe609', 4.81788814, -75.69976105'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, 'ef69d4fa-63cb-474c-964f-33aa323dc5c9', 4.6337949, -74.06733996'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '519a4246-fcd8-4ea9-a504-0cc90a98ee48', 4.70709922, -74.10950061'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '9e9a1f45-e757-4fed-bd53-02bfd1e460da', 4.5703607, -74.08840265'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '3ce353cc-64d0-454e-9017-e78e20a1ea59', 4.61640679, -74.15623609'), 
('6728f0d1-a14d-4c40-abb3-a7dc38c1be13', 4.33616925, -74.36648795, '28a6a180-c834-4b87-9487-675b8e154131', 10.42049582, -75.53385812'), 
('91bbb47d-1eeb-49b9-a5da-d37ff05f14ff', 10.63055547, -74.92171572, '247f8e1a-c9c9-4e15-9f3b-25dbf46f439c', 11.00268988, -74.81448489'), 
('91bbb47d-1eeb-49b9-a5da-d37ff05f14ff', 10.63055547, -74.92171572, '73875b86-2838-4add-867c-605ae1492d7a', 7.12671431, -73.11446761'), 
('91bbb47d-1eeb-49b9-a5da-d37ff05f14ff', 10.63055547, -74.92171572, 'f44b0557-1c17-41b9-ac66-f1ef5d23d75c', 8.75154953, -75.88373388'), 
('91bbb47d-1eeb-49b9-a5da-d37ff05f14ff', 10.63055547, -74.92171572, 'c2e9ecc7-0705-42a9-b41a-e588973c41aa', 9.30392915, -75.39277521'), 
('91bbb47d-1eeb-49b9-a5da-d37ff05f14ff', 10.63055547, -74.92171572, '11dae2e2-b01e-43b4-a927-62aa994d25b7', 10.47088148, -73.25380372'), 
('91bbb47d-1eeb-49b9-a5da-d37ff05f14ff', 10.63055547, -74.92171572, '28a6a180-c834-4b87-9487-675b8e154131', 10.42049582, -75.53385812'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, '247f8e1a-c9c9-4e15-9f3b-25dbf46f439c', 11.00268988, -74.81448489'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, '73875b86-2838-4add-867c-605ae1492d7a', 7.12671431, -73.11446761'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, '0422850d-2cb9-4099-b8e0-010d5dfb15ee', 3.45242438, -76.49312468'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, '34a97b79-6c6c-44a8-9925-2dc41ffdae8d', 7.89752044, -72.50620117'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, '75196896-46f6-49c4-85fd-731cd50daf83', 6.2624319, -75.56404755'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, 'f44b0557-1c17-41b9-ac66-f1ef5d23d75c', 8.75154953, -75.88373388'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, '1b2f89c9-4709-4764-afc2-36a7faafe609', 4.81788814, -75.69976105'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, 'c2e9ecc7-0705-42a9-b41a-e588973c41aa', 9.30392915, -75.39277521'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, '11dae2e2-b01e-43b4-a927-62aa994d25b7', 10.47088148, -73.25380372'), 
('341ed6b6-2944-4f09-ab42-2bc2cfec5183', 7.85211871, -76.64077724, '28a6a180-c834-4b87-9487-675b8e154131', 10.42049582, -75.53385812'), 
('fc261052-71e1-4b9c-b363-08a9e1b985ad', 4.54522231, -75.66075423, '0422850d-2cb9-4099-b8e0-010d5dfb15ee', 3.45242438, -76.49312468'), 
('fc261052-71e1-4b9c-b363-08a9e1b985ad', 4.54522231, -75.66075423, '75196896-46f6-49c4-85fd-731cd50daf83', 6.2624319, -75.56404755'), 
('fc261052-71e1-4b9c-b363-08a9e1b985ad', 4.54522231, -75.66075423, '97d0fec5-fc75-40d5-973d-18a21f9f5e80', 2.93248615, -75.28494502'), 
('fc261052-71e1-4b9c-b363-08a9e1b985ad', 4.54522231, -75.66075423, '1b2f89c9-4709-4764-afc2-36a7faafe609', 4.81788814, -75.69976105'), 
('68299270-eb81-4a8c-8183-7bf3824e1416', 4.54728629, -75.66215642, '0422850d-2cb9-4099-b8e0-010d5dfb15ee', 3.45242438, -76.49312468'), 
('68299270-eb81-4a8c-8183-7bf3824e1416', 4.54728629, -75.66215642, '75196896-46f6-49c4-85fd-731cd50daf83', 6.2624319, -75.56404755'), 
('68299270-eb81-4a8c-8183-7bf3824e1416', 4.54728629, -75.66215642, '97d0fec5-fc75-40d5-973d-18a21f9f5e80', 2.93248615, -75.28494502'), 
('68299270-eb81-4a8c-8183-7bf3824e1416', 4.54728629, -75.66215642, '1b2f89c9-4709-4764-afc2-36a7faafe609', 4.81788814, -75.69976105'), 
('eda90991-75c3-4dec-a37c-639c188ae5a5', 7.07425837, -73.11001516, '247f8e1a-c9c9-4e15-9f3b-25dbf46f439c', 11.00268988, -74.81448489'), 
('eda90991-75c3-4dec-a37c-639c188ae5a5', 7.07425837, -73.11001516, '73875b86-2838-4add-867c-605ae1492d7a', 7.12671431, -73.11446761'), 
('eda90991-75c3-4dec-a37c-639c188ae5a5', 7.07425837, -73.11001516, '34a97b79-6c6c-44a8-9925-2dc41ffdae8d', 7.89752044, -72.50620117'), 
('eda90991-75c3-4dec-a37c-639c188ae5a5', 7.07425837, -73.11001516, '75196896-46f6-49c4-85fd-731cd50daf83', 6.2624319, -75.56404755'), 
('eda90991-75c3-4dec-a37c-639c188ae5a5', 7.07425837, -73.11001516, 'f44b0557-1c17-41b9-ac66-f1ef5d23d75c', 8.75154953, -75.88373388'), 
('eda90991-75c3-4dec-a37c-639c188ae5a5', 7.07425837, -73.11001516, '1b2f89c9-4709-4764-afc2-36a7faafe609', 4.81788814, -75.69976105'), 
('eda90991-75c3-4dec-a37c-639c188ae5a5', 7.07425837, -73.11001516, 'c2e9ecc7-0705-42a9-b41a-e588973c41aa', 9.30392915, -75.39277521'), 
('eda90991-75c3-4dec-a37c-639c188ae5a5', 7.07425837, -73.11001516, '11dae2e2-b01e-43b4-a927-62aa994d25b7', 10.47088148, -73.25380372'), 
('eda90991-75c3-4dec-a37c-639c188ae5a5', 7.07425837, -73.11001516, '28a6a180-c834-4b87-9487-675b8e154131', 10.42049582, -75.53385812'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '73875b86-2838-4add-867c-605ae1492d7a', 7.12671431, -73.11446761'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '0422850d-2cb9-4099-b8e0-010d5dfb15ee', 3.45242438, -76.49312468'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '34a97b79-6c6c-44a8-9925-2dc41ffdae8d', 7.89752044, -72.50620117'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '75196896-46f6-49c4-85fd-731cd50daf83', 6.2624319, -75.56404755'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, 'f44b0557-1c17-41b9-ac66-f1ef5d23d75c', 8.75154953, -75.88373388'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '97d0fec5-fc75-40d5-973d-18a21f9f5e80', 2.93248615, -75.28494502'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '1b2f89c9-4709-4764-afc2-36a7faafe609', 4.81788814, -75.69976105'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, 'ef69d4fa-63cb-474c-964f-33aa323dc5c9', 4.6337949, -74.06733996'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '519a4246-fcd8-4ea9-a504-0cc90a98ee48', 4.70709922, -74.10950061'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '9e9a1f45-e757-4fed-bd53-02bfd1e460da', 4.5703607, -74.08840265'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '3ce353cc-64d0-454e-9017-e78e20a1ea59', 4.61640679, -74.15623609'), 
('6edb1cd0-ab22-4f88-83c2-1f0c2cd9512d', 5.45075112, -74.66304, '28a6a180-c834-4b87-9487-675b8e154131', 10.42049582, -75.53385812'), 
('0970fa22-0c93-4a6f-8cdf-fd5c8b7357c2', 8.65735868, -75.13105537, '247f8e1a-c9c9-4e15-9f3b-25dbf46f439c', 11.00268988, -74.81448489'), 
('0970fa22-0c93-4a6f-8cdf-fd5c8b7357c2', 8.65735868, -75.13105537, 'f44b0557-1c17-41b9-ac66-f1ef5d23d75c', 8.75154953, -75.88373388'), 
('b2d8c227-13c9-4526-81db-74bb073b9b61', 9.0069862, -73.97232138, '247f8e1a-c9c9-4e15-9f3b-25dbf46f439c', 11.00268988, -74.81448489'), 
('b2d8c227-13c9-4526-81db-74bb073b9b61', 9.0069862, -73.97232138, '73875b86-2838-4add-867c-605ae1492d7a', 7.12671431, -73.11446761'), 
('b2d8c227-13c9-4526-81db-74bb073b9b61', 9.0069862, -73.97232138, '34a97b79-6c6c-44a8-9925-2dc41ffdae8d', 7.89752044, -72.50620117'), 
('b2d8c227-13c9-4526-81db-74bb073b9b61', 9.0069862, -73.97232138, 'f44b0557-1c17-41b9-ac66-f1ef5d23d75c', 8.75154953, -75.88373388'), 
('b2d8c227-13c9-4526-81db-74bb073b9b61', 9.0069862, -73.97232138, 'c2e9ecc7-0705-42a9-b41a-e588973c41aa', 9.30392915, -75.39277521'), 
('b2d8c227-13c9-4526-81db-74bb073b9b61', 9.0069862, -73.97232138, '11dae2e2-b01e-43b4-a927-62aa994d25b7', 10.47088148, -73.25380372'), 
('b2d8c227-13c9-4526-81db-74bb073b9b61', 9.0069862, -73.97232138, '28a6a180-c834-4b87-9487-675b8e154131', 10.42049582, -75.53385812'), 
('2a83536f-e0a1-4c3d-84bc-0ebff5a9dfc7', 11.54310523, -72.91138675, '73875b86-2838-4add-867c-605ae1492d7a', 7.12671431, -73.11446761'), 
('28af72e1-4de7-4ab7-86b9-c40af70dacb9', 4.58190378, -74.21285347, '73875b86-2838-4add-867c-605ae1492d7a', 7.12671431, -73.11446761'), 
('ec36b8f3-ebc4-41e6-816c-410e9218dfb9', 4.71155675, -74.02981032, 'ef69d4fa-63cb-474c-964f-33aa323dc5c9', 4.6337949, -74.06733996'), 
('ec36b8f3-ebc4-41e6-816c-410e9218dfb9', 4.71155675, -74.02981032, '519a4246-fcd8-4ea9-a504-0cc90a98ee48', 4.70709922, -74.10950061'), 
('ec36b8f3-ebc4-41e6-816c-410e9218dfb9', 4.71155675, -74.02981032, '9e9a1f45-e757-4fed-bd53-02bfd1e460da', 4.5703607, -74.08840265'), 
('ec36b8f3-ebc4-41e6-816c-410e9218dfb9', 4.71155675, -74.02981032, '3ce353cc-64d0-454e-9017-e78e20a1ea59', 4.61640679, -74.15623609'), 
('b996cf39-047b-45d5-a436-4d8f1924777f', 4.6922429, -74.05582247, 'ef69d4fa-63cb-474c-964f-33aa323dc5c9', 4.6337949, -74.06733996'), 
('b996cf39-047b-45d5-a436-4d8f1924777f', 4.6922429, -74.05582247, '519a4246-fcd8-4ea9-a504-0cc90a98ee48', 4.70709922, -74.10950061'), 
('b996cf39-047b-45d5-a436-4d8f1924777f', 4.6922429, -74.05582247, '9e9a1f45-e757-4fed-bd53-02bfd1e460da', 4.5703607, -74.08840265'), 
('b996cf39-047b-45d5-a436-4d8f1924777f', 4.6922429, -74.05582247, '3ce353cc-64d0-454e-9017-e78e20a1ea59', 4.61640679, -74.15623609'), 
('e2810197-c987-4de3-885c-9db027d47906', 4.7200938, -74.04648098, 'ef69d4fa-63cb-474c-964f-33aa323dc5c9', 4.6337949, -74.06733996'), 
('e2810197-c987-4de3-885c-9db027d47906', 4.7200938, -74.04648098, '519a4246-fcd8-4ea9-a504-0cc90a98ee48', 4.70709922, -74.10950061'), 
('e2810197-c987-4de3-885c-9db027d47906', 4.7200938, -74.04648098, '9e9a1f45-e757-4fed-bd53-02bfd1e460da', 4.5703607, -74.08840265'), 
('e2810197-c987-4de3-885c-9db027d47906', 4.7200938, -74.04648098, '3ce353cc-64d0-454e-9017-e78e20a1ea59', 4.61640679, -74.15623609'), 
('7b87adbe-0a1f-4c50-9f6a-383cfa42051b', 4.69719188, -74.03985831, 'ef69d4fa-63cb-474c-964f-33aa323dc5c9', 4.6337949, -74.06733996'), 
('7b87adbe-0a1f-4c50-9f6a-383cfa42051b', 4.69719188, -74.03985831, '519a4246-fcd8-4ea9-a504-0cc90a98ee48', 4.70709922, -74.10950061'), 
('7b87adbe-0a1f-4c50-9f6a-383cfa42051b', 4.69719188, -74.03985831, '9e9a1f45-e757-4fed-bd53-02bfd1e460da', 4.5703607, -74.08840265'), 
('7b87adbe-0a1f-4c50-9f6a-383cfa42051b', 4.69719188, -74.03985831, '3ce353cc-64d0-454e-9017-e78e20a1ea59', 4.61640679, -74.15623609'), 
('f099495c-c13b-4cb4-a8a0-734baa75a4a6', 4.72162687, -74.04713889, 'ef69d4fa-63cb-474c-964f-33aa323dc5c9', 4.6337949, -74.06733996'), 
('f099495c-c13b-4cb4-a8a0-734baa75a4a6', 4.72162687, -74.04713889, '519a4246-fcd8-4ea9-a504-0cc90a98ee48', 4.70709922, -74.10950061'), 
('f099495c-c13b-4cb4-a8a0-734baa75a4a6', 4.72162687, -74.04713889, '9e9a1f45-e757-4fed-bd53-02bfd1e460da', 4.5703607, -74.08840265'), 
('f099495c-c13b-4cb4-a8a0-734baa75a4a6', 4.72162687, -74.04713889, '3ce353cc-64d0-454e-9017-e78e20a1ea59', 4.61640679, -74.15623609'), 
('bbdf914a-fbe1-45fa-a3fe-22858447e291', 4.69510177, -74.036186, 'ef69d4fa-63cb-474c-964f-33aa323dc5c9', 4.6337949, -74.06733996'), 
('bbdf914a-fbe1-45fa-a3fe-22858447e291', 4.69510177, -74.036186, '519a4246-fcd8-4ea9-a504-0cc90a98ee48', 4.70709922, -74.10950061'), 
('bbdf914a-fbe1-45fa-a3fe-22858447e291', 4.69510177, -74.036186, '9e9a1f45-e757-4fed-bd53-02bfd1e460da', 4.5703607, -74.08840265'), 
('bbdf914a-fbe1-45fa-a3fe-22858447e291', 4.69510177, -74.036186, '3ce353cc-64d0-454e-9017-e78e20a1ea59', 4.61640679, -74.15623609');

-- Buscar coincidencias en travel_time_cache
WITH matches AS (
    SELECT 
        rn.hospital_id,
        rn.kam_id,
        ttc.travel_time,
        ttc.distance,
        ttc.source
    FROM routes_needed rn
    INNER JOIN travel_time_cache ttc ON
        ABS(ttc.origin_lat - rn.kam_lat) < 0.001 AND
        ABS(ttc.origin_lng - rn.kam_lng) < 0.001 AND
        ABS(ttc.dest_lat - rn.hospital_lat) < 0.001 AND
        ABS(ttc.dest_lng - rn.hospital_lng) < 0.001
    WHERE ttc.source = 'google_maps'
)
SELECT COUNT(*) as rutas_encontradas FROM matches;

-- Insertar las encontradas en hospital_kam_distances
INSERT INTO hospital_kam_distances (hospital_id, kam_id, travel_time, distance, source)
SELECT 
    hospital_id,
    kam_id,
    travel_time,
    distance,
    source
FROM matches
ON CONFLICT (hospital_id, kam_id) DO NOTHING;
